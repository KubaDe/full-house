on:
  workflow_call:

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: ./

    steps:
      - name: â˜ï¸ Checkout source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: âš™ï¸Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.4.0

      - name: âš™ï¸ Set node version
        uses: actions/setup-node@v4
        with:
          node-version: '20.14.0'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: ğŸšš Install Node dependencies
        id: install
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run tests
        if: (failure() || success()) && steps.install.outcome == 'success'
        id: tests
        run: pnpm run test

      - name: ğŸª¦ Check for dead code
        if: (failure() || success()) && steps.install.outcome == 'success'
        id: deadcode
        run: pnpm run knip

      - name: ğŸ¡ Check for circular dependencies
        if: (failure() || success()) && steps.install.outcome == 'success'
        id: madge
        run: pnpm run madge

      - name: ğŸ•µï¸ Lint project
        if: (failure() || success()) && steps.install.outcome == 'success'
        id: lint
        run: pnpm run lint

      - name: ğŸ“° Publish summary comment
        if: success() || failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              # PR code checks results:
              |    |  Step                           | Status                                                                                                           |
              | -- | --------------------------------| -----------------------------------------------------------------------------------------------------------------|
              | ğŸšš |  Install packages               | ${{ (steps.install.outcome == 'success' && 'âœ…') || (steps.install.outcome == 'failure' && 'âŒ') || 'â­ï¸' }}     |
              | ğŸ•µï¸ |  Lint project                   | ${{ (steps.lint.outcome == 'success' && 'âœ…') || (steps.lint.outcome == 'failure' && 'âŒ') || 'â­ï¸' }}           |
              | ğŸ§ªï¸ |  Run test                       | ${{ (steps.tests.outcome == 'success' && 'âœ…') || (steps.tests.outcome == 'failure' && 'âŒ') || 'â­ï¸' }}         |
              | ğŸª¦ |  Check for dead code            | ${{ (steps.deadcode.outcome == 'success' && 'âœ…') || (steps.deadcode.outcome == 'failure' && 'âŒ') || 'â­ï¸' }}   |
              | ğŸ¡ |  Check for circlar dependencies | ${{ (steps.madge.outcome == 'success' && 'âœ…') || (steps.madge.outcome == 'failure' && 'âŒ') || 'â­ï¸' }}   |
              ------------
              [See details]( ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `
            })
